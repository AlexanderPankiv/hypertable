#!/bin/bash
#
# Copyright (C) 2009  Luke Lu (llu@hypertable.org)
#
# This file is part of Hypertable.
#
# Hypertable is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 2
# of the License, or any later version.
#
# Hypertable is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Hypertable. If not, see <http://www.gnu.org/licenses/>
#
export HYPERTABLE_HOME=$(cd `dirname "$0"`/.. && pwd)
. $HYPERTABLE_HOME/bin/ht-env.sh

do_start() {
  service=$1; shift
  exec $HYPERTABLE_HOME/bin/start-$service.sh "$@"
}

do_stop() {
  service=$1; shift
  if [ -x $HYPERTABLE_HOME/bin/stop-$service.sh ]; then
    exec $HYPERTABLE_HOME/bin/stop-$service.sh "$@"
  fi
  pidfile=`server_pidfile $service`
  stop_server $service &&
  sleep 1 &&
  wait_for_server_shutdown $service `basename $pidfile .pid` "$@"
}

do_restart() {
  service=$1
  if [ -x $HYPERTABLE_HOME/bin/restart-$service.sh ]; then
    shift;
    exec $HYPERTABLE_HOME/bin/restart-$service.sh "$@"
  fi
  do_stop "$@"
  do_start "$@"
}

do_cmd() {
  cmd=$1; shift
  if [ -x $HYPERTABLE_HOME/bin/$cmd ]; then
    exec $HYPERTABLE_HOME/bin/$cmd "$@"
  elif [ -x $HYPERTABLE_HOME/bin/$cmd.sh ]; then
    exec $HYPERTABLE_HOME/bin/$cmd.sh "$@"
  fi
  exec $cmd "$@";
}

cmd=$1
shift

case $cmd in
  start)        do_start "$@";;
  stop)         do_stop "$@";;
  restart)      do_restart "$@";;
  shell)        exec $HYPERTABLE_HOME/bin/hypertable "$@";;
  /*)           exec $cmd "$@";;
  *)            do_cmd "$cmd" "$@";;
esac
